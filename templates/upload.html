{% extends "base.html" %}

{% block title %}Upload - Contract Processing Platform{% endblock %}
{% block page_title %}Upload Contract{% endblock %}

{% block content %}
<div class="upload-container">
    <!-- Progress Indicator -->
    <div class="upload-progress-indicator">
        <div class="progress-step active" id="step1">
            <div class="progress-number">1</div>
            <div class="progress-label">Upload PDF</div>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step" id="step2">
            <div class="progress-number">2</div>
            <div class="progress-label">Extract Data</div>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step" id="step3">
            <div class="progress-number">3</div>
            <div class="progress-label">Review & Confirm</div>
        </div>
    </div>

    <!-- Step 1: Upload -->
    <div class="upload-section" id="uploadSection">
        <div class="upload-card">
            <div class="upload-header">
                <h2>Upload Contract PDF</h2>
                <p>Drag and drop your PDF file or click to browse</p>
            </div>

            <div class="upload-area" id="uploadArea">
                <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                <h3>Drop PDF here</h3>
                <p>or click to browse your computer</p>
                <p class="upload-hint">Max file size: 16 MB</p>
                <input type="file" id="fileInput" accept=".pdf" style="display: none;">
            </div>

            <div id="fileInfo" class="file-info" style="display: none;">
                <div class="file-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    </svg>
                    <div class="file-details">
                        <p class="file-name" id="fileName"></p>
                        <p class="file-size" id="fileSize"></p>
                    </div>
                    <button type="button" class="btn-remove" id="removeFileBtn">Remove</button>
                </div>
            </div>

            <div class="upload-actions">
                <button id="extractBtn" class="btn btn-primary btn-lg btn-block" disabled>
                    <span id="extractBtnText">Extract Data</span>
                    <span id="extractLoader" class="loader" style="display: none;"></span>
                </button>
            </div>

            <div id="uploadStatus" class="status-message"></div>
        </div>
    </div>

    <!-- Step 2 & 3: Review & Confirm -->
    <div class="review-section" id="reviewSection" style="display: none;">
        <!-- Data Viewer -->
        <div class="review-card">
            <div class="card-header">
                <h3>Review & Edit Extracted Data</h3>
                <div class="view-toggle">
                    <button class="toggle-btn active" id="formViewBtn">Form View</button>
                    <button class="toggle-btn" id="jsonViewBtn">JSON View</button>
                </div>
            </div>

            <!-- Form View -->
            <div id="formView" class="data-view-container">
                <div id="extractedForm" class="extracted-form-grid">
                    <p class="loading">Loading form...</p>
                </div>
            </div>

            <!-- JSON View -->
            <div id="jsonView" class="data-view-container" style="display: none;">
                <textarea 
                    id="jsonEditor" 
                    class="json-editor" 
                    placeholder="Extracted data will appear here..."
                    spellcheck="false"
                ></textarea>
            </div>

            <div class="review-actions">
                <button id="confirmBtn" class="btn btn-primary btn-lg" disabled style="display: none;">
                    <span id="confirmBtnText">Create Subscription</span>
                    <span id="confirmLoader" class="loader" style="display: none;"></span>
                </button>
            </div>

            <!-- Result Display (Inline) -->
            <div id="resultContainer" style="display: none; margin-top: 1rem;">
                <!-- Success Result -->
                <div id="successResult" style="display: none;">
                    <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05)); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 12px; padding: 2rem; text-align: center;">
                        <div style="width: 60px; height: 60px; background: rgba(34, 197, 94, 0.2); border: 2px solid #22c55e; border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; color: #22c55e;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="32" height="32">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </div>
                        <h3 style="margin: 0 0 0.5rem; color: #22c55e;">Subscription Created Successfully!</h3>
                        <p style="margin: 0 0 1rem; color: var(--text-secondary);">Your subscription has been created in Chargebee.</p>
                        <p id="successSubId" style="margin: 0 0 1.5rem; color: var(--text-primary); font-family: monospace; font-size: 0.9rem;">Subscription ID: -</p>
                        <button id="successStartOverBtn" class="btn btn-secondary" style="font-size: 0.875rem; padding: 0.5rem 1rem;">Start Over</button>
                    </div>
                </div>
                
                <!-- Failure Result -->
                <div id="failureResult" style="display: none;">
                    <div style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05)); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 2rem; text-align: center;">
                        <div style="width: 60px; height: 60px; background: rgba(239, 68, 68, 0.2); border: 2px solid #ef4444; border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; color: #ef4444;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="32" height="32">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </div>
                        <h3 style="margin: 0 0 0.5rem; color: #ef4444;">Subscription Creation Failed</h3>
                        <p id="failureMessage" style="margin: 0 0 1.5rem; color: var(--text-secondary);">An error occurred while creating the subscription.</p>
                        <button id="retryPinBtn" class="btn btn-primary" style="margin-right: 0.5rem; font-size: 0.875rem; padding: 0.5rem 1rem;">Retry</button>
                        <button id="failureStartOverBtn" class="btn btn-secondary" style="font-size: 0.875rem; padding: 0.5rem 1rem;">Start Over</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- PIN Authentication Modal -->
<div id="pinAuthModal" class="modal-overlay" style="display: none;">
    <div class="auth-modal">
        <div class="auth-modal-header">
            <h2>Confirm Action</h2>
            <p>Enter PIN to create subscription in Chargebee</p>
        </div>
        <form id="pinAuthForm" class="auth-form">
            <div class="form-group">
                <label for="confirmPin">PIN</label>
                <input 
                    type="password" 
                    id="confirmPin" 
                    class="form-input" 
                    placeholder="Enter PIN"
                    autocomplete="off"
                />
            </div>
            <div id="pinError" class="error-message" style="display: none;"></div>
            <button type="submit" class="btn btn-primary btn-block">Confirm</button>
            <button type="button" class="btn btn-secondary btn-block" onclick="document.getElementById('pinAuthModal').style.display='none'">Cancel</button>
        </form>
    </div>
</div>



<style>
.upload-container {
    max-width: 900px;
    margin: 0 auto;
}

.upload-progress-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 2rem;
    gap: 1rem;
}

.progress-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
}

.progress-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    transition: all 0.3s;
    color: var(--text-secondary);
}

.progress-step.active .progress-number {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-color: var(--primary);
    color: white;
    box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
}

.progress-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
    text-align: center;
}

.progress-line {
    width: 60px;
    height: 2px;
    background: var(--border);
    margin: 0 0.5rem;
}

.upload-section,
.review-section {
    display: grid;
    gap: 1.5rem;
}

.upload-card,
.review-card {
    background: rgba(30, 41, 59, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 2rem;
    backdrop-filter: blur(10px);
}

.upload-header,
.card-header {
    margin-bottom: 2rem;
}

.upload-header h2,
.card-header h3 {
    margin-bottom: 0.5rem;
}

.upload-header p,
.card-header p {
    color: var(--text-secondary);
}

.upload-area {
    border: 2px dashed rgba(102, 126, 234, 0.3);
    border-radius: 12px;
    padding: 3.5rem 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    margin-bottom: 1.5rem;
    background: rgba(102, 126, 234, 0.05);
}

.upload-area:hover {
    border-color: var(--primary);
    background: rgba(102, 126, 234, 0.1);
}

.upload-area.dragover {
    border-color: var(--primary);
    background: rgba(102, 126, 234, 0.15);
    transform: scale(1.02);
}

.upload-icon {
    width: 48px;
    height: 48px;
    color: var(--primary);
    margin-bottom: 1rem;
}

.upload-area h3 {
    margin-bottom: 0.25rem;
}

.upload-area p {
    color: var(--text-secondary);
    font-size: 0.95rem;
}

.upload-hint {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 0.5rem;
}

.file-info {
    background: rgba(37, 99, 235, 0.1);
    border: 1px solid rgba(37, 99, 235, 0.3);
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1.5rem;
}

.file-item {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.file-item svg {
    width: 32px;
    height: 32px;
    color: var(--primary);
    flex-shrink: 0;
}

.file-details {
    flex: 1;
}

.file-name {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.file-size {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.btn-remove {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 0.875rem;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    transition: all 0.2s;
}

.btn-remove:hover {
    background: rgba(239, 68, 68, 0.1);
    color: #f87171;
}

.upload-actions,
.review-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.view-toggle {
    display: flex;
    gap: 0.5rem;
    background: rgba(15, 23, 42, 0.5);
    padding: 0.3rem;
    border-radius: 8px;
}

.toggle-btn {
    padding: 0.5rem 1rem;
    background: transparent;
    border: none;
    color: var(--text-secondary);
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.875rem;
    transition: all 0.2s;
}

.toggle-btn.active {
    background: var(--primary);
    color: white;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
}

.data-view-container {
    margin: 1.5rem 0;
}

.extracted-form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.25rem;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.form-group label {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-secondary);
}

.form-input {
    padding: 0.75rem;
    background: rgba(15, 23, 42, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 0.875rem;
    transition: all 0.2s;
}

.form-input:focus {
    outline: none;
    border-color: var(--primary);
    background: rgba(15, 23, 42, 0.8);
    box-shadow: 0 0 12px rgba(102, 126, 234, 0.1);
}

.json-editor {
    width: 100%;
    min-height: 500px;
    padding: 1rem;
    background: rgba(15, 23, 42, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    color: var(--text-primary);
    font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
    font-size: 0.875rem;
    line-height: 1.6;
    resize: vertical;
    transition: all 0.2s;
}

.json-editor:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 20px rgba(37, 99, 235, 0.15);
}

.review-section .card-header {
    display: none;
}

@media (max-width: 768px) {
    .upload-progress-indicator {
        flex-wrap: wrap;
        font-size: 0.875rem;
    }

    .progress-line {
        width: 30px;
        margin: 0 0.25rem;
    }

    .progress-number {
        width: 32px;
        height: 32px;
        font-size: 0.875rem;
    }

    .upload-area {
        padding: 2rem 1rem;
    }

    .extracted-form {
        grid-template-columns: 1fr;
    }

    .review-actions {
        flex-direction: column;
    }

    .json-editor {
        min-height: 300px;
    }
}
</style>
{% endblock %}
